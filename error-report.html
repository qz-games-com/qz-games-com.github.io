<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Reporter Test Page</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            line-height: 1.6;
        }

        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-entry.log {
            border-left-color: #4ec9b0;
            color: #4ec9b0;
        }

        .log-entry.error {
            border-left-color: #f48771;
            color: #f48771;
        }

        .log-entry.warn {
            border-left-color: #dcdcaa;
            color: #dcdcaa;
        }

        .log-entry.info {
            border-left-color: #569cd6;
            color: #569cd6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            color: #f5576c;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 15px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .error-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .decoded-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .decoded-section h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .decoded-section pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }

        .screenshot-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêõ Error Reporter Test Page (Optimized)</h1>
            <p class="description">
                This test page demonstrates the <strong>optimized error reporting system</strong> with ~85-90% size reduction.
                Features: LZString EncodedURIComponent compression, optimized screenshot capture (30% quality/scale),
                smart data pruning (20 logs max, 200 char limit), and configurable compression settings.
                Click buttons to trigger errors, generate reports, and test the compression system.
            </p>
        </div>

        <div class="test-section">
            <h2>Trigger Test Errors</h2>
            <div class="button-grid">
                <button onclick="triggerReferenceError()">ReferenceError</button>
                <button onclick="triggerTypeError()">TypeError</button>
                <button onclick="triggerSyntaxError()">SyntaxError</button>
                <button onclick="triggerCustomError()">Custom Error</button>
                <button onclick="triggerConsoleSpam()">Console Spam</button>
                <button onclick="triggerWarnings()">Generate Warnings</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Compression Settings (Optimized)</h2>
            <p class="description" style="margin-bottom: 15px;">
                These settings control how aggressively the error report is compressed. Current settings provide ~85-90% size reduction.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" id="screenshotToggle" checked onchange="toggleScreenshot()">
                        <strong>Include Screenshot</strong>
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <strong>Screenshot Quality:</strong>
                        <select id="screenshotQuality" onchange="updateQuality()" style="margin-left: 10px; padding: 5px;">
                            <option value="0.2">Low (20%)</option>
                            <option value="0.3" selected>Medium (30%)</option>
                            <option value="0.5">High (50%)</option>
                            <option value="0.8">Very High (80%)</option>
                        </select>
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <strong>Screenshot Scale:</strong>
                        <select id="screenshotScale" onchange="updateScale()" style="margin-left: 10px; padding: 5px;">
                            <option value="0.25">Tiny (25%)</option>
                            <option value="0.3" selected>Small (30%)</option>
                            <option value="0.5">Medium (50%)</option>
                            <option value="1.0">Full (100%)</option>
                        </select>
                    </label>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 10px;">
                        <strong>Console Logs in Report:</strong>
                        <select id="maxLogsCount" onchange="updateMaxLogs()" style="margin-left: 10px; padding: 5px;">
                            <option value="10">10 logs</option>
                            <option value="20" selected>20 logs</option>
                            <option value="50">50 logs</option>
                            <option value="100">100 logs</option>
                        </select>
                    </label>
                    <p style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 14px;">
                        <strong>Encoding:</strong> LZString EncodedURIComponent<br>
                        <strong>Status:</strong> <span style="color: #4caf50;">‚úì Optimized</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>Generate Error Report</h2>
            <div class="button-grid">
                <button class="success" onclick="generateManualReport()">üì∏ Generate Report (Manual)</button>
                <button class="success" onclick="generateReportWithError()">‚ö†Ô∏è Generate Report (With Last Error)</button>
                <button class="secondary" onclick="clearConsole()">üóëÔ∏è Clear Console</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Console Output (Captured)</h2>
            <div class="console-output" id="consoleOutput">
                <div class="log-entry info">Console capture active. Logs will appear here...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>Decode Error Report</h2>
            <p class="description" style="margin-bottom: 15px;">Paste an error code below to decode and view the report details.</p>
            <textarea id="decodeInput" placeholder="Paste error code here (e.g., ERR-N4Ig...)"></textarea>
            <div class="button-group">
                <button class="success" onclick="decodeReport()">üîç Decode Report</button>
                <button class="secondary" onclick="clearDecode()">Clear</button>
            </div>
            <div id="decodedOutput"></div>
        </div>
    </div>

    <!-- Error Report Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <h3>üêõ Error Report Generated</h3>
            <div class="error-info">
                <strong>Report created successfully!</strong><br>
                Copy the code below and save it for debugging.
            </div>
            <div id="reportStats" class="stats"></div>
            <textarea id="errorCodeOutput" readonly></textarea>
            <div class="button-group">
                <button class="success" onclick="copyErrorCode()">üìã Copy Code</button>
                <button class="secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Include required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

    <script>
        // Error Reporter Class
        class ErrorReporter {
            constructor() {
                this.consoleLogs = [];
                this.maxLogs = 100;
                this.lastError = null;

                // Optimized settings
                this.screenshotEnabled = true;
                this.screenshotQuality = 0.3;  // 30% quality
                this.screenshotScale = 0.3;    // 30% scale
                this.maxConsoleLogsInReport = 20;  // Only 20 logs in report
                this.maxLogLength = 200;  // Truncate logs to 200 chars

                this.captureConsoleLogs();
                this.setupErrorHandler();
            }

            // Intercept console methods
            captureConsoleLogs() {
                const self = this;
                ['log', 'error', 'warn', 'info'].forEach(method => {
                    const original = console[method];
                    console[method] = function(...args) {
                        self.addLog(method, args);
                        original.apply(console, args);
                        self.updateConsoleDisplay();
                    };
                });
            }

            setupErrorHandler() {
                const self = this;
                window.addEventListener('error', (event) => {
                    self.lastError = {
                        message: event.message,
                        filename: event.filename,
                        lineno: event.lineno,
                        colno: event.colno,
                        stack: event.error?.stack || 'No stack trace available'
                    };
                    console.error('Error caught:', event.message);
                });
            }

            addLog(type, args) {
                let message = args.map(a => {
                    if (typeof a === 'object') {
                        try {
                            return JSON.stringify(a, null, 2);
                        } catch (e) {
                            return String(a);
                        }
                    }
                    return String(a);
                }).join(' ');

                // Truncate message if too long (for storage efficiency)
                if (message.length > this.maxLogLength) {
                    message = message.substring(0, this.maxLogLength) + '...';
                }

                this.consoleLogs.push({
                    type,
                    message,
                    timestamp: Date.now()
                });

                // Keep only last maxLogs entries
                if (this.consoleLogs.length > this.maxLogs) {
                    this.consoleLogs.shift();
                }
            }

            updateConsoleDisplay() {
                const output = document.getElementById('consoleOutput');
                const lastLog = this.consoleLogs[this.consoleLogs.length - 1];
                if (lastLog) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${lastLog.type}`;
                    const time = new Date(lastLog.timestamp).toLocaleTimeString();
                    entry.textContent = `[${time}] [${lastLog.type.toUpperCase()}] ${lastLog.message}`;
                    output.appendChild(entry);
                    output.scrollTop = output.scrollHeight;
                }
            }

            async generateReport(errorInfo = null) {
                console.log('Generating error report...');

                const report = {
                    error: errorInfo || this.lastError || { message: 'Manual report - no error' },
                    console: this.consoleLogs.slice(-this.maxConsoleLogsInReport), // Last 20 logs only
                    screenshot: this.screenshotEnabled ? await this.captureScreenshot() : null,
                    device: this.getDeviceInfo(),
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    settings: this.getUserSettings(),
                    performance: this.getPerformanceMetrics()
                };

                console.log('Report data collected, compressing...');
                return this.compressReport(report);
            }

            async captureScreenshot() {
                try {
                    console.log('Capturing screenshot...');
                    const canvas = await html2canvas(document.body, {
                        scale: this.screenshotScale, // Optimized: 30% scale
                        logging: false,
                        width: Math.min(window.innerWidth, 1200), // Max 1200px width
                        height: Math.min(window.innerHeight, 900) // Max 900px height
                    });
                    return canvas.toDataURL('image/jpeg', this.screenshotQuality); // Optimized: 30% quality
                } catch (error) {
                    console.error('Screenshot capture failed:', error);
                    return null;
                }
            }

            getDeviceInfo() {
                // Shorten user agent to save space
                const ua = navigator.userAgent;
                const shortUA = ua.length > 100 ? ua.substring(0, 100) + '...' : ua;

                return {
                    userAgent: shortUA,
                    platform: navigator.platform,
                    screenSize: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    language: navigator.language,
                    memory: navigator.deviceMemory || 'N/A',
                    cores: navigator.hardwareConcurrency || 'N/A',
                    online: navigator.onLine
                };
            }

            getUserSettings() {
                const cookies = document.cookie.split(';');
                const settings = {};
                cookies.forEach(cookie => {
                    const [key, value] = cookie.split('=').map(s => s.trim());
                    if (key) settings[key] = value;
                });
                return settings;
            }

            getPerformanceMetrics() {
                const perf = performance.getEntriesByType('navigation')[0];
                return {
                    loadTime: perf ? perf.loadEventEnd - perf.fetchStart : 'unknown',
                    domContentLoaded: perf ? perf.domContentLoadedEventEnd - perf.fetchStart : 'unknown',
                    memoryUsed: performance.memory ? performance.memory.usedJSHeapSize : 'unknown'
                };
            }

            compressReport(report) {
                const json = JSON.stringify(report);
                const originalSize = json.length;
                console.log(`Original JSON size: ${originalSize} bytes`);

                // OPTIMIZED: Use compressToEncodedURIComponent for better compression
                const compressed = LZString.compressToEncodedURIComponent(json);
                const compressedSize = compressed.length;
                const ratio = ((1 - compressedSize / originalSize) * 100).toFixed(1);

                console.log(`Compressed size: ${compressedSize} bytes`);
                console.log(`Compression ratio: ${ratio}% reduction`);

                // Calculate final code size with prefix
                const finalCode = `ERR-${compressed}`;
                const finalSize = finalCode.length;

                return {
                    code: finalCode,
                    stats: {
                        originalSize,
                        compressedSize,
                        finalSize,
                        ratio,
                        timestamp: report.timestamp,
                        screenshotIncluded: report.screenshot !== null
                    }
                };
            }

            decompressReport(errorCode) {
                try {
                    const compressed = errorCode.replace('ERR-', '');

                    // Try new encoding first (EncodedURIComponent)
                    let json = LZString.decompressFromEncodedURIComponent(compressed);

                    // Fallback to old Base64 encoding if that fails
                    if (!json) {
                        console.log('Trying Base64 fallback...');
                        json = LZString.decompressFromBase64(compressed);
                    }

                    if (!json) throw new Error('Decompression failed');
                    return JSON.parse(json);
                } catch (error) {
                    console.error('Failed to decompress report:', error);
                    return null;
                }
            }

            clearLogs() {
                this.consoleLogs = [];
                document.getElementById('consoleOutput').innerHTML =
                    '<div class="log-entry info">Console cleared.</div>';
            }
        }

        // Initialize error reporter
        const errorReporter = new ErrorReporter();
        console.log('Error Reporter initialized!');

        // Compression settings handlers
        function toggleScreenshot() {
            errorReporter.screenshotEnabled = document.getElementById('screenshotToggle').checked;
            console.log('Screenshot enabled:', errorReporter.screenshotEnabled);
        }

        function updateQuality() {
            errorReporter.screenshotQuality = parseFloat(document.getElementById('screenshotQuality').value);
            console.log('Screenshot quality:', errorReporter.screenshotQuality);
        }

        function updateScale() {
            errorReporter.screenshotScale = parseFloat(document.getElementById('screenshotScale').value);
            console.log('Screenshot scale:', errorReporter.screenshotScale);
        }

        function updateMaxLogs() {
            errorReporter.maxConsoleLogsInReport = parseInt(document.getElementById('maxLogsCount').value);
            console.log('Max console logs in report:', errorReporter.maxConsoleLogsInReport);
        }

        // Test functions
        function triggerReferenceError() {
            try {
                nonExistentFunction();
            } catch (e) {
                console.error('ReferenceError triggered:', e.message);
            }
        }

        function triggerTypeError() {
            try {
                null.someMethod();
            } catch (e) {
                console.error('TypeError triggered:', e.message);
            }
        }

        function triggerSyntaxError() {
            try {
                eval('this is not valid javascript {]');
            } catch (e) {
                console.error('SyntaxError triggered:', e.message);
            }
        }

        function triggerCustomError() {
            try {
                throw new Error('This is a custom test error with stack trace');
            } catch (e) {
                console.error('Custom error:', e.message);
                console.error('Stack:', e.stack);
            }
        }

        function triggerConsoleSpam() {
            console.log('Log message 1');
            console.log('Log message 2');
            console.info('Info: Operation started');
            console.log('Processing data...');
            console.log('Data:', { id: 123, name: 'Test', items: [1, 2, 3] });
            console.info('Info: Operation completed');
        }

        function triggerWarnings() {
            console.warn('Warning: Low memory detected');
            console.warn('Warning: Deprecated API usage');
            console.warn('Warning: Slow network connection');
        }

        function clearConsole() {
            errorReporter.clearLogs();
        }

        // Report generation
        async function generateManualReport() {
            const result = await errorReporter.generateReport({
                message: 'Manual report generated by user',
                type: 'manual',
                timestamp: Date.now()
            });
            showReportModal(result);
        }

        async function generateReportWithError() {
            if (!errorReporter.lastError) {
                alert('No error has been captured yet. Trigger an error first!');
                return;
            }
            const result = await errorReporter.generateReport(errorReporter.lastError);
            showReportModal(result);
        }

        function showReportModal(result) {
            const modal = document.getElementById('errorModal');
            const output = document.getElementById('errorCodeOutput');
            const stats = document.getElementById('reportStats');

            output.value = result.code;

            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${(result.stats.originalSize / 1024).toFixed(1)}KB</div>
                    <div class="stat-label">Original Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(result.stats.finalSize / 1024).toFixed(1)}KB</div>
                    <div class="stat-label">Final Code Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.stats.ratio}%</div>
                    <div class="stat-label">Size Reduction</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.stats.screenshotIncluded ? 'Yes' : 'No'}</div>
                    <div class="stat-label">Screenshot</div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('errorModal').classList.remove('active');
        }

        function copyErrorCode() {
            const output = document.getElementById('errorCodeOutput');
            output.select();
            document.execCommand('copy');
            alert('Error code copied to clipboard!');
        }

        // Decoder
        function decodeReport() {
            const input = document.getElementById('decodeInput').value.trim();
            if (!input) {
                alert('Please paste an error code first!');
                return;
            }

            const report = errorReporter.decompressReport(input);
            if (!report) {
                alert('Failed to decode report. Invalid error code!');
                return;
            }

            displayDecodedReport(report);
        }

        function displayDecodedReport(report) {
            const output = document.getElementById('decodedOutput');

            let html = '<div class="decoded-section">';

            // Error info
            html += '<h4>Error Information</h4>';
            html += `<pre>${JSON.stringify(report.error, null, 2)}</pre>`;

            // Device info
            html += '<h4>Device Information</h4>';
            html += `<pre>${JSON.stringify(report.device, null, 2)}</pre>`;

            // Performance
            html += '<h4>Performance Metrics</h4>';
            html += `<pre>${JSON.stringify(report.performance, null, 2)}</pre>`;

            // Console logs
            html += '<h4>Console Logs (Last 10)</h4>';
            html += '<pre>';
            const lastLogs = report.console.slice(-10);
            lastLogs.forEach(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                html += `[${time}] [${log.type.toUpperCase()}] ${log.message}\n`;
            });
            html += '</pre>';

            // Screenshot
            if (report.screenshot) {
                html += '<h4>Screenshot</h4>';
                html += `<img src="${report.screenshot}" class="screenshot-preview" alt="Screenshot">`;
            }

            // Metadata
            html += '<h4>Report Metadata</h4>';
            html += `<pre>Timestamp: ${report.timestamp}\nURL: ${report.url}</pre>`;

            html += '</div>';

            output.innerHTML = html;
        }

        function clearDecode() {
            document.getElementById('decodeInput').value = '';
            document.getElementById('decodedOutput').innerHTML = '';
        }

        // Close modal on background click
        document.getElementById('errorModal').addEventListener('click', (e) => {
            if (e.target.id === 'errorModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
