<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quartz Games | Settings</title>
  <link rel="icon" href="./Q.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap">
  <link rel="stylesheet" href="./styles/settings.css">
  <link rel="stylesheet" href="./animations.css">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J246XWP5WQ"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-J246XWP5WQ');
  </script>
  <script src="./cookieshandle.js"></script>
  <script src="./GlobalSettings.js"></script>
</head>
<body>
  <!--NOTIFICATION-->
  <div id="notafication" class="notafication">
    <div class="notaficationin">
      <img id="cookiepic" src="./cookieimg.png" style="display: none;"/>
      <div class="notaficationinn">
        <h1 id="titlenote">Notification</h1>
        <p id="descnote">Message</p>
        <span id="closenote" class="material-icons notranslate">close</span>
      </div>
    </div>
  </div>

  <div class="page-wrapper">
    <header class="top-header">
      <div class="logo">
        <a href="./index.html" class="home-link">
          <span class="material-icons">home</span>
          <span>Home</span>
        </a>
      </div>
      <h1 class="page-title">Settings</h1>
      <button id="mobile-menu-toggle" class="mobile-menu-toggle">
        <span class="material-icons">menu</span>
      </button>
    </header>

    <div class="settings-container">
      <nav class="settings-nav">
        <ul class="nav-list">
          <li><button class="tab-btn active" data-target="main">General</button></li>
          <li><button class="tab-btn" data-target="custom">Performance</button></li>
          <li><button class="tab-btn" data-target="language">Language</button></li>
          <li><button class="tab-btn" data-target="weather">Weather</button></li>
          <li><button class="tab-btn" data-target="cache">Cache Control</button></li>
          <li><button class="tab-btn" data-target="theme">Themes</button></li>
          <!--li><button class="tab-btn" data-target="backgrounds">Backgrounds</button></li-->
        </ul>
      </nav>
      
      <main class="settings-main">
        <section id="main" class="section active">
          <div class="section-header">
            <h2>General Settings</h2>
            <p class="section-description">Configure basic functionality of your Quartz Games experience</p>
          </div>

          <div class="settings-group">
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Prevent Page Close</span>
                <span class="toggle-description">Show a confirmation before page is closed, prevents unintentional page close attempts (works on goguardian and others).</span>
              </div>
              <label class="toggle-switch">
                <input id="checkprevent" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            
          
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Sound Effects</span>
                <span class="toggle-description">Enable or disable sound.</span>
              </div>
              <label style="filter: brightness(50%);" class="toggle-switch" >
                <input id="" type="checkbox"  disabled/>
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </section>
        
        <section id="custom" class="section">
          <div class="section-header">
            <h2>Performance Settings</h2>
            <p class="section-description">Customize your performance related settings.</p>
          </div>
          
          <div class="settings-group">
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Disable Animations</span>
                <span class="toggle-description">Disables page animations, on deviced such as chromebooks this can improve loading times and performance. <br> (does not apply to games and may break some functions of the site) </span>
              </div>
              <label class="toggle-switch">
                <input id="disab" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Reduce Visual Effects</span>
                <span class="toggle-description">Disables blur effects and heavy visual filters for significantly better performance on low-end devices and Chromebooks.</span>
              </div>
              <label class="toggle-switch">
                <input id="reduceEffects" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

        </section>

        <section id="language" class="section">
          <div class="section-header">
            <h2>Language Settings</h2>
            <p class="section-description">Configure automatic translation and language preferences</p>
          </div>

          <div class="settings-group">
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Auto-Translate</span>
                <span class="toggle-description">Automatically translate the site to your browser's preferred language on page load.</span>
              </div>
              <label class="toggle-switch">
                <input id="autoTranslateToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="info-container" style="margin-top: 20px;">
              <div class="info-row">
                <span class="info-label">Browser Language</span>
                <span class="info-value" id="browserLang">--</span>
              </div>
              <div class="info-row">
                <span class="info-label">Current Language</span>
                <span class="info-value" id="currentLang">English (en)</span>
              </div>
            </div>

            <div style="margin-top: 20px;">
              <label for="languageSelect" style="display: block; margin-bottom: 10px; font-weight: 500;">Manual Language Selection:</label>
              <select id="languageSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px;">
                <option value="">Select a language...</option>
              </select>
            </div>

            <div class="action-buttons-group" style="margin-top: 20px;">
              <button class="action-btn" id="resetLangBtn">
                <span class="material-icons">refresh</span>
                Reset to Default (English)
              </button>
            </div>
          </div>
        </section>

        <section id="weather" class="section">
          <div class="section-header">
            <h2>Weather Widget</h2>
            <p class="section-description">Configure weather display preferences</p>
          </div>

          <div class="settings-group">
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Enable Weather Widget</span>
                <span class="toggle-description">Show or hide the weather widget in the sidebar footer.</span>
              </div>
              <label class="toggle-switch">
                <input id="weatherEnabledToggle" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Location Detection Method</span>
                <span class="toggle-description">Choose how to detect your location for weather updates.</span>
              </div>
              <select id="weatherLocationMethod" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px; margin-top: 10px;">
                <option value="geolocation">Browser Geolocation (GPS/WiFi) - Most Accurate</option>
                <option value="ip" selected>IP Location - Automatic, Less Accurate</option>
                <option value="manual">Manual Location</option>
              </select>
            </div>

            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Temperature Unit</span>
                <span class="toggle-description">Choose between Fahrenheit (°F) or Celsius (°C) for temperature display.</span>
              </div>
              <select id="weatherTempUnit" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 14px; margin-top: 10px;">
                <option value="fahrenheit">Fahrenheit (°F)</option>
                <option value="celsius">Celsius (°C)</option>
              </select>
            </div>

            <div class="info-container">
              <div class="info-row">
                <span class="info-label">Current Location</span>
                <span class="info-value" id="weatherLocation">Loading...</span>
              </div>
              <div class="info-row">
                <span class="info-label">Last Updated</span>
                <span class="info-value" id="weatherLastUpdate">Never</span>
              </div>
            </div>

            <div class="action-buttons-group">
              <button class="action-btn" id="refreshWeatherBtn">
                <span class="material-icons">refresh</span>
                Refresh Weather
              </button>
            </div>
          </div>
        </section>

        <section id="cache" class="section">
          <div class="section-header">
            <h2>Cache Control</h2>
            <p class="section-description">Manage service worker caching and storage</p>
          </div>

          <div class="settings-group">
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Enable Caching</span>
                <span class="toggle-description">Cache files for offline access and faster loading. Disable to always fetch fresh content.</span>
              </div>
              <label class="toggle-switch">
                <input id="enableCache" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="info-container">
              <div class="info-row">
                <span class="info-label">Cache Size</span>
                <span class="info-value" id="cacheSize">Calculating...</span>
              </div>
              <div class="info-row">
                <span class="info-label">Service Worker Status</span>
                <span class="info-value" id="swStatus">Checking...</span>
              </div>
            </div>

            <div class="action-buttons-group">
              <button class="action-btn" id="clearCacheBtn">
                <span class="material-icons">delete_sweep</span>
                Clear All Cache
              </button>
              <button class="action-btn" id="updateSwBtn">
                <span class="material-icons">update</span>
                Force Update Service Worker
              </button>
              <button class="action-btn secondary" id="refreshCacheInfoBtn">
                <span class="material-icons">refresh</span>
                Refresh Info
              </button>
            </div>
          </div>
        </section>

        <section id="theme" class="section">
          <div class="section-header">
            <h2>Themes</h2>
            <p class="section-description">Choose your preferred theme</p>
          </div>

          <div class="themes-grid">
            <div class="theme-option active" id="classic" data-theme="default">
              <div class="theme-preview">
                <div class="preview-nav"></div>
              </div>
              <div class="theme-info">
                <h3>Classic</h3>
              </div>
            </div>

            <div class="theme-option" id="space" data-theme="space">
              <div class="theme-preview space-theme">
                <div class="preview-nav"></div>
                <div class="space-circle"></div>
              </div>
              <div class="theme-info">
                <h3>Space | Black Hole</h3>
              </div>
            </div>

            <div class="theme-option" id="spaceearth" data-theme="spaceearth">
              <div class="theme-preview space-earth-theme">
                <div class="preview-nav"></div>
                <div class="earth-circle"></div>
              </div>
              <div class="theme-info">
                <h3>Space | Earth</h3>
              </div>
            </div>

            <div class="theme-option" id="midpurp" data-theme="midnight-purple">
              <div class="theme-preview midnight-purple-theme">
                <div class="preview-nav"></div>
              </div>
              <div class="theme-info">
                <h3>Midnight Purple</h3>
              </div>
            </div>

            <div class="theme-option" id="mlg" data-theme="mlg">
              <div class="theme-preview mlg-theme">
                <div class="preview-nav"></div>
              </div>
              <div class="theme-info">
                <h3>MLG</h3>
              </div>
            </div>

            <div class="theme-option" id="mc" data-theme="mc">
              <div class="theme-preview mc-theme">
                <div class="preview-nav"></div>
              </div>
              <div class="theme-info">
                <h3>Minecraft</h3>
              </div>
            </div>

            <div class="theme-option" id="light" data-theme="light">
              <div class="theme-preview light-theme">
                <div class="preview-nav"></div>
              </div>
              <div class="theme-info">
                <h3>Light</h3>
              </div>
            </div>
          </div>
        </section>

        <section id="backgrounds" class="section">
          <div class="section-header">
            <h2>Custom Backgrounds</h2>
            <p class="section-description">Choose dynamic layered backgrounds with parallax effects</p>
          </div>

          <div class="settings-group">
            <div class="toggle-container">
              <div class="toggle-info">
                <span class="toggle-label">Enable Custom Backgrounds</span>
                <span class="toggle-description">Turn on/off the custom background system. When enabled, you can choose from various dynamic layered backgrounds below.</span>
              </div>
              <label class="toggle-switch">
                <input id="customBackgrounds" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="section-header" style="margin-top: 30px;">
            <h3 style="font-size: 1.3em;">Background Themes</h3>
            <p class="section-description">Select a background (independent from color themes)</p>
          </div>

          <div class="themes-grid">
            <div class="theme-option active" id="bg-none" data-background="none">
              <div class="theme-preview">
                <div class="preview-nav"></div>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em; opacity: 0.3;">∅</div>
              </div>
              <div class="theme-info">
                <h3>None</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-mountain" data-background="mountain">
              <div class="theme-preview" style="background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 50%, #90EE90 100%);">
                <div class="preview-nav"></div>
                <div style="position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); width: 80%; height: 30%; background: linear-gradient(to top, #8B7355, #A0826D); clip-path: polygon(0% 100%, 50% 20%, 100% 100%); opacity: 0.7;"></div>
              </div>
              <div class="theme-info">
                <h3>Mountain Scene</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-space" data-background="space">
              <div class="theme-preview" style="background: radial-gradient(circle at 30% 30%, #1a1a2e, #0f0f1e);">
                <div class="preview-nav"></div>
                <div style="position: absolute; top: 30%; left: 30%; width: 30px; height: 30px; background: radial-gradient(circle, #4a69bd, #0c2461); border-radius: 50%;"></div>
                <div style="position: absolute; top: 20%; left: 60%; width: 3px; height: 3px; background: white; border-radius: 50%; box-shadow: 0 0 5px white;"></div>
                <div style="position: absolute; top: 70%; left: 20%; width: 2px; height: 2px; background: white; border-radius: 50%;"></div>
                <div style="position: absolute; top: 50%; left: 80%; width: 2px; height: 2px; background: white; border-radius: 50%;"></div>
              </div>
              <div class="theme-info">
                <h3>Space</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-forest" data-background="forest">
              <div class="theme-preview" style="background: linear-gradient(to bottom, #4A90E2 0%, #7EC8E3 30%, #228B22 100%);">
                <div class="preview-nav"></div>
                <div style="position: absolute; bottom: 10%; left: 20%; width: 15%; height: 40%; background: linear-gradient(to top, #2d5016, #4a7c2f); clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                <div style="position: absolute; bottom: 10%; right: 20%; width: 15%; height: 35%; background: linear-gradient(to top, #2d5016, #4a7c2f); clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
              </div>
              <div class="theme-info">
                <h3>Forest</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-ocean" data-background="ocean">
              <div class="theme-preview" style="background: linear-gradient(to bottom, #87CEEB 0%, #4A90E2 50%, #1E3A8A 100%);">
                <div class="preview-nav"></div>
                <div style="position: absolute; top: 60%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.3);"></div>
                <div style="position: absolute; top: 75%; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.2);"></div>
              </div>
              <div class="theme-info">
                <h3>Ocean</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-desert" data-background="desert">
              <div class="theme-preview" style="background: linear-gradient(to bottom, #FFB347 0%, #FFCC80 50%, #DEB887 100%);">
                <div class="preview-nav"></div>
                <div style="position: absolute; bottom: 20%; left: 30%; width: 40%; height: 25%; background: linear-gradient(to top, #C19A6B, #D2B48C); clip-path: polygon(0% 100%, 20% 50%, 40% 70%, 60% 40%, 80% 60%, 100% 100%);"></div>
              </div>
              <div class="theme-info">
                <h3>Desert</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-city" data-background="city">
              <div class="theme-preview" style="background: linear-gradient(to bottom, #2C3E50 0%, #34495E 50%, #1C2833 100%);">
                <div class="preview-nav"></div>
                <div style="position: absolute; bottom: 30%; left: 20%; width: 10%; height: 30%; background: #34495E; border: 1px solid #5D6D7E;"></div>
                <div style="position: absolute; bottom: 30%; left: 35%; width: 8%; height: 40%; background: #34495E; border: 1px solid #5D6D7E;"></div>
                <div style="position: absolute; bottom: 30%; right: 25%; width: 12%; height: 35%; background: #34495E; border: 1px solid #5D6D7E;"></div>
              </div>
              <div class="theme-info">
                <h3>City</h3>
              </div>
            </div>

            <div class="theme-option" id="bg-abstract" data-background="abstract">
              <div class="theme-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);">
                <div class="preview-nav"></div>
                <div style="position: absolute; top: 30%; left: 20%; width: 30%; height: 30%; background: radial-gradient(circle, rgba(255,255,255,0.2), transparent); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: 20%; right: 20%; width: 40%; height: 40%; background: radial-gradient(circle, rgba(0,0,0,0.2), transparent); border-radius: 50%;"></div>
              </div>
              <div class="theme-info">
                <h3>Abstract</h3>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
  // Tab switching functionality
  const tabButtons = document.querySelectorAll('.tab-btn');
  const sections = document.querySelectorAll('.section');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Remove active class from all buttons and sections
      tabButtons.forEach(btn => btn.classList.remove('active'));
      sections.forEach(section => section.classList.remove('active'));
      
      // Add active class to clicked button and corresponding section
      button.classList.add('active');
      const target = button.getAttribute('data-target');
      document.getElementById(target).classList.add('active');
    });
  });
  
  // Theme selection functionality
  const themeOptions = document.querySelectorAll('.theme-option');
  
  themeOptions.forEach(option => {
    option.addEventListener('click', () => {
      themeOptions.forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      // Get selected theme type
      const selectedTheme = option.getAttribute('data-theme');
      
      // Save theme preference to localStorage
      setCookie('theme', selectedTheme);
      
      // Apply theme (this would connect to your theme system)
      applyTheme(selectedTheme);
    });
  });
  
  // Mobile menu toggle functionality
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const navMenu = document.querySelector('.settings-nav');
  
  if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener('click', () => {
      navMenu.classList.toggle('show');
      
      // Change menu icon based on state
      const menuIcon = mobileMenuToggle.querySelector('.material-icons');
      if (navMenu.classList.contains('show')) {
        menuIcon.textContent = 'close';
      } else {
        menuIcon.textContent = 'menu';
      }
    });
  }
  
  // Range slider functionality
  const interfaceSlider = document.getElementById('interface-size');
  const rangeValue = document.querySelector('.range-value');
  
  if (interfaceSlider && rangeValue) {
    interfaceSlider.addEventListener('input', () => {
      rangeValue.textContent = `${interfaceSlider.value}%`;
    });
  }
  
  // Prevent page close functionality
  const preventPageClose = document.getElementById('checkprevent');
  
  if (preventPageClose) {
    // Load saved preference
    preventPageClose.checked = getCookie('preventPageClose') === 'true';
    
    preventPageClose.addEventListener('change', () => {
      setCookie('preventPageClose', preventPageClose.checked);
      
      if (preventPageClose.checked) {
        enablePreventPageClose();
      } else {
        disablePreventPageClose();
      }
    });
    
    // Initialize state based on saved preference
    if (preventPageClose.checked) {
      enablePreventPageClose();
    }
  }
  
  // Load and initialize all saved preferences
  loadSavedPreferences();
});

// Apply selected theme
function applyTheme(theme) {
  console.log(`Theme applied: ${theme}`);
  // This would connect to your existing theme system
  // For example:
  // document.body.setAttribute('data-theme', theme);
}

// Apply selected background (independent from theme)
function applyBackground(background) {
  console.log(`Background applied: ${background}`);
  // This message is shown in settings page
  // The actual background loading happens in index.html via loadSelectedBackground()
}

// Prevent page close functionality
function enablePreventPageClose() {
  window.addEventListener('beforeunload', handleBeforeUnload);
}

function disablePreventPageClose() {
  window.removeEventListener('beforeunload', handleBeforeUnload);
}

function handleBeforeUnload(event) {
  event.preventDefault();
  event.returnValue = '';
  return '';
}

// Load all saved preferences
// Apply interface size scaling
function applyInterfaceSize(size) {
  // This sets a CSS variable that could be used to scale UI elements
  document.documentElement.style.setProperty('--ui-scale', `${size / 100}`);
  console.log(`Interface size set to ${size}%`);
}

// Responsive behavior when window is resized
window.addEventListener('resize', handleWindowResize);

function handleWindowResize() {
  const isMobile = window.innerWidth <= 768;
  const navMenu = document.querySelector('.settings-nav');
  
  if (!isMobile && navMenu) {
    // Always show nav on desktop/tablet
    navMenu.classList.remove('show');
    
    // Reset menu icon
    const menuIcon = document.querySelector('.mobile-menu-toggle .material-icons');
    if (menuIcon) {
      menuIcon.textContent = 'menu';
    }
  }
}

function loadSavedPreferences() {
  // Load theme preference
  const savedTheme =getCookie('theme');
  if (savedTheme) {
    const themeElement = document.querySelector(`[data-theme="${savedTheme}"]`);
    if (themeElement) {
      themeElement.click();
    }
  }
  
  // Load notification preference
  const disab = document.getElementById('disab');

  if (disab) {
    // Load saved preference
    disab.checked = getCookie('disableAnimations') === 'true';

    disab.addEventListener('change', () => {
      setCookie('disableAnimations', disab.checked);
      console.log(getCookie('disableAnimations'))
    });

  }

  // Reduce Visual Effects preference
  const reduceEffects = document.getElementById('reduceEffects');

  if (reduceEffects) {
    // Load saved preference
    const saved = localStorage.getItem('reduceVisualEffects') === 'true';
    reduceEffects.checked = saved;

    // Apply immediately if enabled
    if (saved) {
      document.body.classList.add('reduce-effects');
    }

    reduceEffects.addEventListener('change', () => {
      localStorage.setItem('reduceVisualEffects', reduceEffects.checked);

      // Apply/remove class immediately
      if (reduceEffects.checked) {
        document.body.classList.add('reduce-effects');
      } else {
        document.body.classList.remove('reduce-effects');
      }
    });
  }

  // Load custom backgrounds preference
  const customBackgrounds = document.getElementById('customBackgrounds');

  if (customBackgrounds) {
    // Load saved preference
    customBackgrounds.checked = getCookie('customBackgrounds') !== 'false'; // default to true

    customBackgrounds.addEventListener('change', () => {
      setCookie('customBackgrounds', customBackgrounds.checked);
      console.log('Custom Backgrounds:', customBackgrounds.checked);
    });
  }

  // Weather Widget Settings
  const weatherEnabledToggle = document.getElementById('weatherEnabledToggle');
  const weatherLocationMethod = document.getElementById('weatherLocationMethod');
  const weatherTempUnit = document.getElementById('weatherTempUnit');
  const weatherLocationDisplay = document.getElementById('weatherLocation');
  const weatherLastUpdate = document.getElementById('weatherLastUpdate');
  const refreshWeatherBtn = document.getElementById('refreshWeatherBtn');

  // Update display info function
  function updateWeatherInfo() {
    const savedLocation = localStorage.getItem('weather_location');
    const lastUpdate = localStorage.getItem('weather_last_update');

    if (savedLocation) {
      try {
        const location = JSON.parse(savedLocation);
        weatherLocationDisplay.textContent = location.name || 'Unknown';
      } catch (e) {
        weatherLocationDisplay.textContent = 'Unknown';
      }
    } else {
      weatherLocationDisplay.textContent = 'Not set';
    }

    if (lastUpdate) {
      const date = new Date(parseInt(lastUpdate));
      weatherLastUpdate.textContent = date.toLocaleString();
    } else {
      weatherLastUpdate.textContent = 'Never';
    }
  }

  // Enable/Disable Weather Widget
  if (weatherEnabledToggle) {
    // Load saved preference (default to true)
    const enabled = localStorage.getItem('weather_enabled');
    weatherEnabledToggle.checked = enabled === 'false' ? false : true;

    weatherEnabledToggle.addEventListener('change', () => {
      const isEnabled = weatherEnabledToggle.checked;
      localStorage.setItem('weather_enabled', isEnabled.toString());

      // Call the weather widget function to update
      if (typeof window.updateWeatherSettings === 'function') {
        window.updateWeatherSettings();
      }

      console.log('Weather Widget Enabled:', isEnabled);
    });
  }

  // Location Detection Method
  if (weatherLocationMethod) {
    // Load saved preference (default to IP location)
    const savedMethod = localStorage.getItem('weather_location_method') || 'ip';
    weatherLocationMethod.value = savedMethod;

    weatherLocationMethod.addEventListener('change', () => {
      const selectedMethod = weatherLocationMethod.value;
      localStorage.setItem('weather_location_method', selectedMethod);

      // Call the weather widget function to update
      if (typeof window.updateWeatherSettings === 'function') {
        window.updateWeatherSettings();
      }

      console.log('Weather Location Method:', selectedMethod);
    });
  }

  // Temperature Unit Settings
  if (weatherTempUnit) {
    // Load saved preference (default to fahrenheit)
    const savedUnit = localStorage.getItem('weather_temp_unit') || 'fahrenheit';
    weatherTempUnit.value = savedUnit;

    weatherTempUnit.addEventListener('change', () => {
      const selectedUnit = weatherTempUnit.value;
      localStorage.setItem('weather_temp_unit', selectedUnit);

      // Call the weather widget function to update
      if (typeof window.updateWeatherSettings === 'function') {
        window.updateWeatherSettings();
      }

      console.log('Weather Temperature Unit:', selectedUnit);
    });
  }

  // Initial display update
  if (weatherLocationDisplay && weatherLastUpdate) {
    updateWeatherInfo();
  }

  // Refresh Weather Button
  if (refreshWeatherBtn) {
    refreshWeatherBtn.addEventListener('click', () => {
      // Force refresh weather widget
      if (typeof window.updateWeatherSettings === 'function') {
        window.updateWeatherSettings();
      }

      // Update display after a short delay
      setTimeout(() => {
        updateWeatherInfo();
      }, 1000);
    });
  }

  // Background selection functionality (separate from themes)
  const backgroundOptions = document.querySelectorAll('[data-background]');

  // Load saved background preference
  const savedBackground = getCookie('selectedBackground') || 'none';
  backgroundOptions.forEach(option => {
    if (option.getAttribute('data-background') === savedBackground) {
      option.classList.add('active');
    } else {
      option.classList.remove('active');
    }
  });

  backgroundOptions.forEach(option => {
    option.addEventListener('click', () => {
      // Remove active class from all background options
      backgroundOptions.forEach(opt => opt.classList.remove('active'));

      // Add active class to clicked option
      option.classList.add('active');

      // Get selected background type
      const selectedBackground = option.getAttribute('data-background');

      // Save background preference to cookie
      setCookie('selectedBackground', selectedBackground);

      console.log('Background selected:', selectedBackground);

      // Apply background if enabled
      if (customBackgrounds && customBackgrounds.checked) {
        applyBackground(selectedBackground);
      }
    });
  });

  // Load sound effects preference
  const soundEffectsToggle = document.getElementById('soundeffects');
  if (soundEffectsToggle) {
    const savedSoundEffects = localStorage.getItem('enableSoundEffects');
    soundEffectsToggle.checked = savedSoundEffects === null ? true : savedSoundEffects === 'true';
    
    soundEffectsToggle.addEventListener('change', () => {
      localStorage.setItem('enableSoundEffects', soundEffectsToggle.checked);
    });
  }

  
  // Handle interface size if available
  const interfaceSizeSlider = document.getElementById('interface-size');
  if (interfaceSizeSlider) {
    const savedSize = localStorage.getItem('interfaceSize');
    if (savedSize) {
      interfaceSizeSlider.value = savedSize;
      document.querySelector('.range-value').textContent = `${savedSize}%`;
      applyInterfaceSize(savedSize);
    }

    interfaceSizeSlider.addEventListener('change', () => {
      const newSize = interfaceSizeSlider.value;
      localStorage.setItem('interfaceSize', newSize);
      applyInterfaceSize(newSize);
    });
  }

  // ===== Cache Control Functionality =====
  const enableCacheToggle = document.getElementById('enableCache');
  const clearCacheBtn = document.getElementById('clearCacheBtn');
  const updateSwBtn = document.getElementById('updateSwBtn');
  const refreshCacheInfoBtn = document.getElementById('refreshCacheInfoBtn');
  const cacheSizeEl = document.getElementById('cacheSize');
  const swStatusEl = document.getElementById('swStatus');

  // Load cache setting - default to FALSE (no caching)
  const cacheEnabled = localStorage.getItem('cacheEnabled') === 'true';
  if (enableCacheToggle) {
    enableCacheToggle.checked = cacheEnabled;
  }

  // Toggle caching
  if (enableCacheToggle) {
    enableCacheToggle.addEventListener('change', async () => {
      const enabled = enableCacheToggle.checked;
      localStorage.setItem('cacheEnabled', enabled);

      if (!enabled) {
        // Clear cache when disabled
        await clearAllCaches();
        updateCacheInfo();
      }

      issuenote(
        enabled ? 'Caching Enabled' : 'Caching Disabled',
        enabled ? 'Caching has been enabled. Reload the page to apply changes.' : 'Caching has been disabled and cache cleared.',
        true,
        'cache'
      );
    });
  }

  // Calculate cache size
  async function calculateCacheSize() {
    try {
      if (!('caches' in window)) {
        return 'Not supported';
      }

      const cacheNames = await caches.keys();
      let totalSize = 0;

      for (const cacheName of cacheNames) {
        const cache = await caches.open(cacheName);
        const keys = await cache.keys();

        for (const request of keys) {
          const response = await cache.match(request);
          if (response) {
            const blob = await response.blob();
            totalSize += blob.size;
          }
        }
      }

      // Convert to readable format
      if (totalSize === 0) return '0 KB';
      if (totalSize < 1024) return `${totalSize} bytes`;
      if (totalSize < 1024 * 1024) return `${(totalSize / 1024).toFixed(2)} KB`;
      return `${(totalSize / (1024 * 1024)).toFixed(2)} MB`;
    } catch (error) {
      return 'Error calculating';
    }
  }

  // Get service worker status
  async function getServiceWorkerStatus() {
    try {
      if (!('serviceWorker' in navigator)) {
        return 'Not supported';
      }

      const registration = await navigator.serviceWorker.getRegistration();
      if (!registration) {
        return 'Not registered';
      }

      if (registration.active) {
        return 'Active';
      } else if (registration.installing) {
        return 'Installing';
      } else if (registration.waiting) {
        return 'Waiting';
      }

      return 'Unknown';
    } catch (error) {
      return 'Error';
    }
  }

  // Update cache info
  async function updateCacheInfo() {
    if (cacheSizeEl) {
      cacheSizeEl.textContent = 'Calculating...';
      const size = await calculateCacheSize();
      cacheSizeEl.textContent = size;
    }

    if (swStatusEl) {
      swStatusEl.textContent = 'Checking...';
      const status = await getServiceWorkerStatus();
      swStatusEl.textContent = status;
    }
  }

  // Clear all caches
  async function clearAllCaches() {
    try {
      if (!('caches' in window)) {
        issuenote('Cache Not Supported', 'Cache API is not supported in your browser.', true, 'error');
        return;
      }

      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));

      return true;
    } catch (error) {
      issuenote('Error Clearing Cache', `An error occurred: ${error.message}`, true, 'error');
      return false;
    }
  }

  // Clear cache button
  if (clearCacheBtn) {
    clearCacheBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to clear all cached data?')) {
        return;
      }

      clearCacheBtn.disabled = true;
      clearCacheBtn.innerHTML = '<span class="material-icons">hourglass_empty</span>Clearing...';

      const success = await clearAllCaches();

      if (success) {
        issuenote('Cache Cleared', 'All cached data has been successfully cleared.', true, 'success');
        await updateCacheInfo();
      }

      clearCacheBtn.disabled = false;
      clearCacheBtn.innerHTML = '<span class="material-icons">delete_sweep</span>Clear All Cache';
    });
  }

  // Force update service worker
  if (updateSwBtn) {
    updateSwBtn.addEventListener('click', async () => {
      try {
        const registration = await navigator.serviceWorker.getRegistration();

        if (!registration) {
          issuenote('No Service Worker', 'No service worker is currently registered.', true, 'error');
          return;
        }

        updateSwBtn.disabled = true;
        updateSwBtn.innerHTML = '<span class="material-icons">hourglass_empty</span>Updating...';

        await registration.update();

        if (registration.waiting) {
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        }

        issuenote('Service Worker Updated', 'Service worker update initiated. Reload the page to apply changes.', true, 'success');

        updateSwBtn.disabled = false;
        updateSwBtn.innerHTML = '<span class="material-icons">update</span>Force Update Service Worker';
      } catch (error) {
        issuenote('Update Error', `Error updating service worker: ${error.message}`, true, 'error');
        updateSwBtn.disabled = false;
        updateSwBtn.innerHTML = '<span class="material-icons">update</span>Force Update Service Worker';
      }
    });
  }

  // Refresh cache info button
  if (refreshCacheInfoBtn) {
    refreshCacheInfoBtn.addEventListener('click', updateCacheInfo);
  }

  // Initial cache info update
  updateCacheInfo();

  // ===== Language Settings Functionality =====
  const autoTranslateToggle = document.getElementById('autoTranslateToggle');
  const languageSelect = document.getElementById('languageSelect');
  const resetLangBtn = document.getElementById('resetLangBtn');
  const browserLangEl = document.getElementById('browserLang');
  const currentLangEl = document.getElementById('currentLang');

  // Load Google Translate script for settings page
  function loadGoogleTranslateForSettings() {
    if(document.getElementById('translatescript')) {
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
    script.type = 'text/javascript';
    script.id = 'translatescript';
    document.head.appendChild(script);
  }

  // Initialize Google Translate Element (needed to get language list)
  window.googleTranslateElementInit = function() {
    new google.translate.TranslateElement({
      pageLanguage: 'en',
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google_translate_element');
  };

  // Load saved auto-translate preference
  if (autoTranslateToggle) {
    const enabled = localStorage.getItem('autoTranslateEnabled');
    autoTranslateToggle.checked = enabled === null || enabled === 'true';

    autoTranslateToggle.addEventListener('change', () => {
      localStorage.setItem('autoTranslateEnabled', autoTranslateToggle.checked);
      if (window.autoTranslate) {
        window.autoTranslate.setAutoTranslateEnabled(autoTranslateToggle.checked);
      }
    });
  }

  // Display browser language
  if (browserLangEl) {
    const browserLang = navigator.language || navigator.userLanguage;
    browserLangEl.textContent = browserLang;
  }

  // Populate language dropdown and handle selection
  function populateLanguages() {
    setTimeout(() => {
      const translateElement = document.querySelector('.goog-te-combo');
      if (translateElement && languageSelect) {
        const options = translateElement.options;
        languageSelect.innerHTML = '<option value="">Select a language...</option>';

        for (let i = 0; i < options.length; i++) {
          const option = options[i];
          if (option.value) {
            const newOption = document.createElement('option');
            newOption.value = option.value;
            newOption.textContent = option.text;
            languageSelect.appendChild(newOption);
          }
        }

        // Set current selection from localStorage
        const savedLang = localStorage.getItem('preferredLanguage');
        if (savedLang) {
          languageSelect.value = savedLang;
          updateCurrentLangDisplay(savedLang);
        }
      } else {
        setTimeout(populateLanguages, 500);
      }
    }, 1000);
  }

  // Update current language display
  function updateCurrentLangDisplay(langCode) {
    if (currentLangEl) {
      if (!langCode || langCode === 'en') {
        currentLangEl.textContent = 'English (en)';
      } else {
        const option = languageSelect.querySelector(`option[value="${langCode}"]`);
        if (option) {
          currentLangEl.textContent = `${option.textContent} (${langCode})`;
        } else {
          currentLangEl.textContent = langCode;
        }
      }
    }
  }

  // Language selection change
  if (languageSelect) {
    languageSelect.addEventListener('change', () => {
      const selectedLang = languageSelect.value;
      if (selectedLang && window.autoTranslate) {
        window.autoTranslate.translateToLanguage(selectedLang);
        updateCurrentLangDisplay(selectedLang);
      }
    });
  }

  // Reset language button
  if (resetLangBtn) {
    resetLangBtn.addEventListener('click', () => {
      if (window.autoTranslate) {
        window.autoTranslate.resetToDefault();
        languageSelect.value = '';
        updateCurrentLangDisplay('en');
        issuenote('Language Reset', 'Language has been reset to English.', true, 'success');
      }
    });
  }

  // Load translate script and populate languages
  loadGoogleTranslateForSettings();
  populateLanguages();
}
  </script>
  <script src="./note.js"></script>
  <script src="./auto-translate.js"></script>
</body>
</html>